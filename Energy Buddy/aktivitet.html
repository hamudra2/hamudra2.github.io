<html>
<head>
	<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300..700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css">
</head>
<body>

<a href='index.html'><div id="backBtn" class="backBtn"><button type="backBtn">Tillbaka</button></div></a>

<div class="buttons-container">
	<div class="diskarcontainer">
		<div class="diskar-text">Diskar</div>
		<img src="diskar2.png" class="diskar-bild">
		<div id="timer">00:00:00.0</div>
	</div>
	<button id="cancelSWBtn">Avbryt</button>
	<button id="pauseSWBtn">Pausa</button>
	<button id="finishSWBtn">Färdig</button>
<div id="finishModal" style="display:none">
  <h2>Hur mycket energi har du nu?</h2>
	<span id="finishpercentageLabel">50%</span>
  <input type="range" id="finishEnergy" min="0" max="100" value="50">
	<p id="finishenergyText">Har Energi</p>
  <button id="confirmFinish">Spara</button>
</div>
</div>


<script>
    let startTime;
    let elapsedBefore = 0;
    let timerInterval;
    let running = false;
    let unloading = false; // <--- NEW

    const pauseBtn = document.getElementById("pauseSWBtn");
    const finishBtn = document.getElementById("finishSWBtn");
    const cancelBtn = document.getElementById("cancelSWBtn");

    function formatTime(ms) {
        const tenths = Math.floor(ms / 100) % 10;
        const seconds = Math.floor(ms / 1000) % 60;
        const minutes = Math.floor(ms / (1000 * 60)) % 60;
        const hours = Math.floor(ms / (1000 * 60 * 60));
        return (
            String(hours).padStart(2, "0") + ":" +
            String(minutes).padStart(2, "0") + ":" +
            String(seconds).padStart(2, "0") + "." + tenths
        );
    }

    function updateDisplay() {
        let total = elapsedBefore;
        if (running) total += Date.now() - startTime;
        document.getElementById("timer").textContent = formatTime(total);
    }

    function startStopwatch() {
        running = true;
        startTime = Date.now();
        timerInterval = setInterval(updateDisplay, 100);
        pauseBtn.textContent = "Pausa";
        saveState();
    }

    function pauseStopwatch() {
        if (!running) return;
        running = false;
        clearInterval(timerInterval);
        elapsedBefore += Date.now() - startTime;
        pauseBtn.textContent = "Återuppta";
        saveState();
    }

    function resumeStopwatch() {
        if (running) return;
        running = true;
        startTime = Date.now();
        timerInterval = setInterval(updateDisplay, 100);
        pauseBtn.textContent = "Pausa";
        saveState();
    }

    function pauseToggle() {
        running ? pauseStopwatch() : resumeStopwatch();
    }

		function finishStopwatch() {
				pauseStopwatch();
				document.getElementById("finishModal").style.display = "block";
		}

    function cancelStopwatch() {
        running = false;
        clearInterval(timerInterval);
        elapsedBefore = 0;
        document.getElementById("timer").textContent = "00:00:00.0";
        pauseBtn.textContent = "Pausa";
        localStorage.removeItem("stopwatchState");
    }

    function saveState() {
        localStorage.setItem("stopwatchState", JSON.stringify({
            elapsedBefore,
            running,
            startTime: running ? startTime : null
        }));
    }

    function loadState() {
        const saved = localStorage.getItem("stopwatchState");
        if (!saved) return;

        const state = JSON.parse(saved);
        elapsedBefore = state.elapsedBefore || 0;
        running = state.running;

        if (running) {
            const delta = Date.now() - state.startTime;
            startTime = Date.now() - delta;
            timerInterval = setInterval(updateDisplay, 100);
            pauseBtn.textContent = "Pausa";
        } else {
            pauseBtn.textContent = "Återuppta";
        }
    }

    // --- FIXED: Do NOT auto-pause during page reload ---
    window.addEventListener("beforeunload", () => {
        unloading = true;
        saveState();
    });

    document.addEventListener("visibilitychange", () => {
        if (unloading) return;  // prevents incorrect pause on reload

        if (document.hidden) pauseStopwatch();
        else resumeStopwatch();
    });

    // Buttons
    pauseBtn.onclick = pauseToggle;
    finishBtn.onclick = finishStopwatch;
    cancelBtn.onclick = cancelStopwatch;

    // Load state on entry
    loadState();
    updateDisplay();

    if (!running) startStopwatch();
		
document.getElementById("confirmFinish").onclick = () => {
  const energyAfter = Number(document.getElementById("finishEnergy").value);

  const current = JSON.parse(localStorage.getItem("currentActivity"));
  if (!current) return;

  const durationMs = elapsedBefore;
  const durationText = formatTime(durationMs);

  const logEntry = {
    startDate: current.startDate,
    activity: current.activity,
    energyBefore: current.energyBefore,
    energyAfter: energyAfter,
    energyDiff: energyAfter - current.energyBefore,
    durationMs: durationMs,
    durationText: durationText
  };

  const logs = JSON.parse(localStorage.getItem("activityLogs")) || [];
  logs.unshift(logEntry);

  localStorage.setItem("activityLogs", JSON.stringify(logs));
	running = false;
	clearInterval(timerInterval);
	elapsedBefore = 0;
	document.getElementById("timer").textContent = "00:00:00.0";
	pauseBtn.textContent = "Pausa";
  localStorage.removeItem("currentActivity");
  localStorage.removeItem("stopwatchState");

  window.location.href = "aktivitet3.html";
};

</script>

<script>
const finishslider = document.getElementById("finishEnergy");
const finishText = document.getElementById("finishenergyText");
const finishPercentage = document.getElementById("finishpercentageLabel");

function updateValues3(value) {
	// Update text ranges
	if (value < 1) {
		finishText.textContent = "Helt utmattad";
	} else if (value < 10) {
		finishText.textContent = "Extremt Trött";
	} else if (value < 20) {
		finishText.textContent = "Väldigt Trött";
	} else if (value < 30) {
		finishText.textContent = "Ganska Trött";
	} else if (value < 40) {
		finishText.textContent = "Lite Trött";
	} else if (value < 50) {
		finishText.textContent = "Börjar Bli Trött";
	} else if (value < 75) {
		finishText.textContent = "Har Energi";
	} else if (value < 100) {
		finishText.textContent = "Mycket Energi";
	} else {
		finishText.textContent = "Helt Pigg";
	}

	// Update percentage label
	finishPercentage.textContent = value + "%";
};

finishslider.addEventListener("input", (e) => {
	updateValues3(e.target.value);
});

// Initialize on load
updateValues3(finishslider.value);
</script>

<script>
const slider5 = document.getElementById("finishEnergy");

function updateSliderFill3() {
  const value = (slider5.value - slider5.min) / (slider5.max - slider5.min) * 100;

  slider5.style.background = `
    linear-gradient(
      to right,
      rgb(187, 169, 233) 0%,
      rgb(187, 169, 233) ${value}%,
      #d3d3d3 ${value}%,
      #d3d3d3 100%
    )
  `;
}

// Initialize + update on input
slider5.addEventListener("input", updateSliderFill3);
updateSliderFill3();
</script>


</body>
</html>