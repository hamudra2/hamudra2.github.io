<html>
<head>
	<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300..700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css">
</head>
<body>

<a href='index.html'><div id="backBtn" class="backBtn"><button type="backBtn">Tillbaka</button></div></a>

<div class="buttons-container">
	<div class="diskarcontainer">
		<div class="diskar-text">Diskar</div>
		<img src="diskar2.png" class="diskar-bild">
		<div id="timer">00:00:00.0</div>
	</div>
	<button id="cancelSWBtn">Avbryt</button>
	<button id="pauseSWBtn">Pausa</button>
	<button id="finishSWBtn">F√§rdig</button>
	

	<div id="brajobbattext">Bra jobbat!</div>
	<div id="brajobbatcontainer">
		<img src="klarat-aktivitet.png" width="300px">
	</div>


<div id="finishModal" style="display:none">
  <h2>Hur mycket energi har du nu?</h2>
	<span id="finishpercentageLabel">50%</span>
  <input type="range" id="finishEnergy" min="0" max="100" value="50">
	<p id="finishenergyText">Har Energi</p>
  <button id="confirmFinish">Spara</button>
</div>
</div>

<!-- On aktivitet.html, there is a small issue. When the timer is completed, if I then switch to another tab and then switch back, the stopwatch starts. --!>


<script>
	let startTime;
	let elapsedBefore = 0;
	let timerInterval;
	let running = false;
	let unloading = false; // <--- NEW

	const pauseBtn = document.getElementById("pauseSWBtn");
	const finishBtn = document.getElementById("finishSWBtn");
	const cancelBtn = document.getElementById("cancelSWBtn");
	
	const current = JSON.parse(localStorage.getItem("currentActivity"));

	const isTimer = current?.mode === "timer";
	let remainingMs = current?.durationMinutes
		? current.durationMinutes * 60 * 1000
		: 0;

	function hideActivityUI() {
		document.querySelector(".diskarcontainer")?.style.setProperty("display", "none");
		pauseBtn.style.display = "none";
		cancelBtn.style.display = "none";
		finishBtn.style.display = "none";

		document.getElementById("brajobbattext").style.display = "block";
		document.getElementById("brajobbatcontainer").style.display = "flex";
	}

	function formatTime(ms) {
		const tenths = Math.floor(ms / 100) % 10;
		const seconds = Math.floor(ms / 1000) % 60;
		const minutes = Math.floor(ms / (1000 * 60)) % 60;
		const hours = Math.floor(ms / (1000 * 60 * 60));
		return (
			String(hours).padStart(2, "0") + ":" +
			String(minutes).padStart(2, "0") + ":" +
			String(seconds).padStart(2, "0") + "." + tenths
		);
	}

	function updateDisplay() {
		let total = elapsedBefore;
		if (running) total += Date.now() - startTime;
		document.getElementById("timer").textContent = formatTime(total);
	}

	function startStopwatch() {
		running = true;
		startTime = Date.now();
		timerInterval = setInterval(updateDisplay, 100);
		pauseBtn.textContent = "Pausa";
		saveState();
	}

	function pauseStopwatch() {
		if (!running) return;
		running = false;
		clearInterval(timerInterval);
		elapsedBefore += Date.now() - startTime;
		pauseBtn.textContent = "√Öteruppta";
		saveState();
	}

	function resumeStopwatch() {
		if (running) return;
		running = true;
		startTime = Date.now();
		timerInterval = setInterval(updateDisplay, 100);
		pauseBtn.textContent = "Pausa";
		saveState();
	}

	function pauseToggle() {
		running ? pauseStopwatch() : resumeStopwatch();
	}
	/*CHANGES HERE */
	function finishStopwatch() {
		pauseStopwatch();

		const finishSlider = document.getElementById("finishEnergy");
		const sharedEnergy = Number(localStorage.getItem("sharedEnergy")) || 50;

		finishSlider.value = sharedEnergy;
		finishSlider.dispatchEvent(new Event("input"));

		document.getElementById("finishModal").style.display = "block";
	}

	function cancelStopwatch() {
		running = false;
		clearInterval(timerInterval);
		elapsedBefore = 0;
		document.getElementById("timer").textContent = "00:00:00.0";
		pauseBtn.textContent = "Pausa";
		localStorage.removeItem("stopwatchState");
	}

	function saveState() {
		localStorage.setItem("stopwatchState", JSON.stringify({
			elapsedBefore,
			running,
			startTime: running ? startTime : null
		}));
	}

	function loadState() {
		const saved = localStorage.getItem("stopwatchState");
		if (!saved) return;

		const state = JSON.parse(saved);
		elapsedBefore = state.elapsedBefore || 0;
		running = state.running;

		if (running) {
			const delta = Date.now() - state.startTime;
			startTime = Date.now() - delta;
			timerInterval = setInterval(updateDisplay, 100);
			pauseBtn.textContent = "Pausa";
		} else {
			pauseBtn.textContent = "√Öteruppta";
		}
	}

	// --- FIXED: Do NOT auto-pause during page reload ---
	window.addEventListener("beforeunload", () => {
		unloading = true;
		saveState();
	});

	document.addEventListener("visibilitychange", () => {
		if (unloading) return;  // prevents incorrect pause on reload

		if (document.hidden) pauseStopwatch();
		else resumeStopwatch();
	});

	// Buttons
	pauseBtn.onclick = pauseToggle;
	finishBtn.onclick = finishStopwatch;
	cancelBtn.onclick = cancelStopwatch;

	// Load state on entry
	loadState();
	updateDisplay();

	//if (!running) startStopwatch();
	//
	//
	//
	//maybe fix?
	//
	//
	//
	if (isTimer) startTimer();
	else startStopwatch();

	function startTimer() {
		running = true;
		startTime = Date.now();

		timerInterval = setInterval(() => {
			const elapsed = Date.now() - startTime;
			const remaining = remainingMs - elapsed;

			if (remaining <= 0) {
				clearInterval(timerInterval);
				document.getElementById("timer").textContent = "00:00:00.0";

				hideActivityUI();     // üëà NEW
				finishStopwatch();   // reuse existing finish flow
				return;
			}

			document.getElementById("timer").textContent =
				formatTime(remaining);
		}, 100);
	}

		
	document.getElementById("confirmFinish").onclick = () => {
		const energyAfter = Number(document.getElementById("finishEnergy").value);
		localStorage.setItem("sharedEnergy", energyAfter);
		
		const current = JSON.parse(localStorage.getItem("currentActivity"));
		if (!current) return;

		const durationMs = elapsedBefore;
		const durationText = formatTime(durationMs);
		
	const startDateObj = new Date(current.startTime || Date.now());
	const endDateObj = new Date();

	const logEntry = {
		type: "activity",

		// --- timestamps ---
		timestamp: endDateObj.getTime(),
		startDate: startDateObj.toISOString().split("T")[0],
		startTime: startDateObj.toLocaleTimeString("sv-SE", {
			hour: "2-digit",
			minute: "2-digit"
		}),

		// --- activity info ---
		activity: current.activity || "Ok√§nd aktivitet",
		mode: current.mode || "stopwatch",

		// --- energy ---
		energyBefore: current.energyBefore ?? "-",
		energyAfter: energyAfter ?? "-",
		energyDiff:
			current.energyBefore != null && energyAfter != null
				? energyAfter - current.energyBefore
				: "-",

		// --- duration ---
		durationMs: elapsedBefore || 0,
		durationText: formatTime(elapsedBefore || 0)
	};


	const logs = JSON.parse(localStorage.getItem("activityLogs")) || [];
	logs.unshift(logEntry);

	localStorage.setItem("activityLogs", JSON.stringify(logs));
	running = false;
	clearInterval(timerInterval);
	elapsedBefore = 0;
	document.getElementById("timer").textContent = "00:00:00.0";
	pauseBtn.textContent = "Pausa";
	localStorage.removeItem("currentActivity");
	localStorage.removeItem("stopwatchState");

	window.location.href = "aktivitet3.html";
	};

</script>
<script src="slider.js"></script>


</body>
</html>
